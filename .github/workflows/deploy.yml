name: Deploy to Elastic Beanstalk

on:
  push:
    branches:
      - develop
  workflow_dispatch: # Permite ejecuciÃ³n manual

env:
  AWS_REGION: eu-south-2
  EB_APPLICATION_NAME: DKAPP
  EB_ENVIRONMENT_NAME: DKAPP-env
  DEPLOY_PACKAGE_NAME: dka-${{ github.sha }}.zip

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
          coverage: none
      
      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-dev --no-interaction --optimize-autoloader
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install NPM dependencies
        run: npm ci
      
      - name: Build frontend assets
        run: npm run build
      
      - name: Create deployment package
        run: |
          # Copiar archivos necesarios (excluir lo innecesario)
          zip -r ${{ env.DEPLOY_PACKAGE_NAME }} . \
            -x ".git/*" \
            -x ".github/*" \
            -x "node_modules/*" \
            -x "vendor/*" \
            -x "tests/*" \
            -x "storage/logs/*" \
            -x "storage/framework/cache/*" \
            -x "storage/framework/sessions/*" \
            -x "storage/framework/views/*" \
            -x ".env" \
            -x ".env.example" \
            -x "*.md" \
            -x "phpunit.xml"
      
      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: ${{ env.DEPLOY_PACKAGE_NAME }}

  deploy:
    name: Deploy to AWS Elastic Beanstalk
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Upload package to S3
        run: |
          aws s3 cp ${{ env.DEPLOY_PACKAGE_NAME }} \
            s3://${{ secrets.EB_S3_BUCKET }}/${{ env.DEPLOY_PACKAGE_NAME }}
          echo "Package uploaded successfully"
      
      - name: Deploy to Elastic Beanstalk
        run: |
          VERSION_LABEL="v-${{ github.run_number }}-$(date +%s)"
          echo "Deploying with version label: $VERSION_LABEL"
          
          aws elasticbeanstalk create-application-version \
            --application-name "${{ env.EB_APPLICATION_NAME }}" \
            --version-label "$VERSION_LABEL" \
            --source-bundle "S3Bucket=${{ secrets.EB_S3_BUCKET }},S3Key=${{ env.DEPLOY_PACKAGE_NAME }}" \
            --auto-create-application \
            --process
          
          echo "Waiting for version to be PROCESSED..."
          for i in {1..60}; do
            STATUS=$(aws elasticbeanstalk describe-application-versions \
              --application-name "${{ env.EB_APPLICATION_NAME }}" \
              --version-labels "$VERSION_LABEL" \
              --query 'ApplicationVersions[0].Status' \
              --output text 2>/dev/null || echo "NOTFOUND")
            
            echo "Attempt $i/60: Status = $STATUS"
            
            if [ "$STATUS" = "PROCESSED" ]; then
              echo "Version is PROCESSED! Deploying..."
              break
            elif [ "$STATUS" = "FAILED" ]; then
              echo "Version processing FAILED!"
              exit 1
            fi
            
            sleep 3
          done
          
          if [ "$STATUS" != "PROCESSED" ]; then
            echo "Timeout waiting for version to be PROCESSED (status: $STATUS)"
            exit 1
          fi
          
          echo "Verifying version exists before deployment..."
          aws elasticbeanstalk describe-application-versions \
            --application-name "${{ env.EB_APPLICATION_NAME }}" \
            --version-labels "$VERSION_LABEL"
          
          echo "Starting deployment to environment..."
          aws elasticbeanstalk update-environment \
            --application-name "${{ env.EB_APPLICATION_NAME }}" \
            --environment-name "${{ env.EB_ENVIRONMENT_NAME }}" \
            --version-label "$VERSION_LABEL"
      
      - name: Wait for deployment to complete
        run: |
          aws elasticbeanstalk wait environment-updated \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --environment-name ${{ env.EB_ENVIRONMENT_NAME }}
      
      - name: Clear Laravel cache and config
        run: |
          # Conectarse al servidor EB y ejecutar comandos de limpieza
          INSTANCE_IDS=$(aws ec2 describe-instances \
            --filters "Name=tag:aws:elasticbeanstalk:environment-name,Values=${{ env.EB_ENVIRONMENT_NAME }}" \
            --query 'Reservations[].Instances[].InstanceId' \
            --output text)
          
          for INSTANCE_ID in $INSTANCE_IDS; do
            echo "Clearing cache on instance: $INSTANCE_ID"
            aws ssm send-command \
              --instance-ids "$INSTANCE_ID" \
              --document-name "AWS-RunShellScript" \
              --parameters 'commands=["cd /var/app/current && php artisan config:cache && php artisan cache:clear"]' \
              --region ${{ env.AWS_REGION }}
          done
      
      - name: Get environment health
        run: |
          aws elasticbeanstalk describe-environment-health \
            --environment-name ${{ env.EB_ENVIRONMENT_NAME }} \
            --attribute-names All
