name: Deploy to Main via SSH Tunnel

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite ejecuci√≥n manual

env:
  DEPLOY_PACKAGE_NAME: dka-${{ github.sha }}.zip
  INTERMEDIATE_HOST: 7.tcp.eu.ngrok.io
  INTERMEDIATE_PORT: 14426
  BACKEND_HOST: 172.20.229.111
  BACKEND_PORT: 22
  BACKEND_USER: root
  DEPLOY_PATH: /var/www/html/dkapp

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
          coverage: none
      
      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-dev --no-interaction --optimize-autoloader
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install NPM dependencies
        run: npm ci
      
      - name: Build frontend assets
        run: npm run build
      
      - name: Create deployment package
        run: |
          # Copiar archivos necesarios (excluir lo innecesario)
          zip -r ${{ env.DEPLOY_PACKAGE_NAME }} . \
            -x ".git/*" \
            -x ".github/*" \
            -x "node_modules/*" \
            -x "vendor/*" \
            -x "tests/*" \
            -x "storage/logs/*" \
            -x "storage/framework/cache/*" \
            -x "storage/framework/sessions/*" \
            -x "storage/framework/views/*" \
            -x ".env" \
            -x ".env.example" \
            -x "*.md" \
            -x "phpunit.xml"
      
      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: ${{ env.DEPLOY_PACKAGE_NAME }}

  deploy:
    name: Deploy via SSH Tunnel
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
      
      - name: Upload package to intermediate server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.INTERMEDIATE_HOST }}
          port: ${{ env.INTERMEDIATE_PORT }}
          username: root
          password: "patata"
          source: ${{ env.DEPLOY_PACKAGE_NAME }}
          target: /root/
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.INTERMEDIATE_HOST }}
          port: ${{ env.INTERMEDIATE_PORT }}
          username: root
          password: "patata"
          script: |
            mkdir -p /var/www/html/dkapp
            chown -R root:root /var/www/html/dkapp
            unzip -o /root/${{ env.DEPLOY_PACKAGE_NAME }} -d /var/www/html/dkapp
            cd /var/www/html/dkapp
            chmod +x .platform/hooks/postdeploy/laravel_setup_ssh.sh
            ./.platform/hooks/postdeploy/laravel_setup_ssh.sh